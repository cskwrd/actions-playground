# This is a basic workflow to help you get started with Actions

name: Debug SMTP via SSH

# Controls when the workflow will run
on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
  push:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name: Clone this repository
        uses: actions/checkout@v3

      - name: Install Haraka
        run: npm install -g Haraka

      - name: Initialize Haraka configuration
        run: |
          haraka -i /tmp/haraka

          # enable debug logging
          echo DEBUG > /tmp/haraka/config/loglevel
          
          # configure haraka to only listen on the loopback interface
          sed -i 's/;listen=\[::0\]:25/listen=127.1.2.3:2525/' /tmp/haraka/config/smtp.ini

          # configure haraka to run in the background
          sed -i 's/;daemonize=true/daemonize=true/' /tmp/haraka/config/smtp.ini
          sed -i 's/;daemon_log_file=\/var\/log\/haraka.log/daemon_log_file=\/var\/log\/haraka.log/' /tmp/haraka/config/smtp.ini
          sed -i 's/;daemon_pid_file=\/var\/run\/haraka.pid/daemon_pid_file=\/var\/run\/haraka.pid/' /tmp/haraka/config/smtp.ini

          # configure plugins
          ### access
          #sed -i 's/# access/access/' /tmp/haraka/config/plugins
          #cat <<ACCESS > /tmp/haraka/config/access.ini
          #[check]
          #any=false
          #conn=false
          #helo=false
          #mail=false
          #rcpt=false
          #
          #[rcpt]
          #accept=false
          #ACCESS

          ## dnsbl
          # do not block mail from bad hosts
          sed -i 's/dnsbl/# dnsbl/' /tmp/haraka/config/plugins

          ## mail_from.is_resolvable
          # allow any address
          sed -i 's/mail_from.is_resolvable/# mail_from.is_resolvable/' /tmp/haraka/config/plugins

          ## rcpt_to.in_host_list
          # allow any address
          sed -i 's/rcpt_to.in_host_list/# rcpt_to.in_host_list/' /tmp/haraka/config/plugins

          ## queue/smtp_forward
          # do not forward mail
          sed -i 's/queue\/smtp_forward/# queue\/smtp_forward/' /tmp/haraka/config/plugins

          ### queue/quarantine
          ## quarantine mail
          #sed -i 's/# queue\/smtp_forward/queue\/quarantine/' /tmp/haraka/config/plugins

          ## queue/test
          # save to tmp directory
          sed -i 's/# queue\/smtp_forward/queue\/test/' /tmp/haraka/config/plugins

          #swaks --to rx@example.com --from tx@example.com --server 127.1.2.3 --port 2525 --auth-user <username> --auth-password <password> --tls

      - name: Setup tmate session
        env:
          THE_EVENT_NAME: ${{ github.event_name }}
          THE_EVENT_PATH: ${{ github.event_path }}
          THE_EVENT_BEFORE: ${{ github.event.before }}
          THE_EVENT_AFTER: ${{ github.event.after }}
        uses: mxschmitt/action-tmate@v3
